
function score_all_stations(stationsfile,scoresfile,myscoresfile,metricsfile,dataRoot,simuRoot,outputfile,N)

sfp = fopen(stationsfile,'r');
cfp = fopen(scoresfile,'w');
rfp = fopen(myscoresfile,'w');
mfp = fopen(metricsfile,'w');

hf = figure('Position',[100 1100 1200 600]);
set(gcf,'PaperUnits','normalized');
set(gcf,'PaperPositionMode','manual');
set(gcf,'PaperOrientation','landscape');
set(gcf,'PaperPosition',[0 0.15 1 0.7]);
ylabels = ['NS';'EW';'UD'];

fprintf(cfp,[...
    ' STATION NAME  NUM       X-COOR       Y-COOR  EpDis(km) '...
    '  FS1   FS2   FB1   FB2   FB3 '...  FB4   FB5 '...
    ' NSS1  EWS1  UDS1 '...
    ' NSS2  EWS2  UDS2 '...
    ' NSB1  EWB1  UDB1 '...
    ' NSB2  EWB2  UDB2 '...
    ' NSB3  EWB3  UDB3 '...    ' NSB4  EWB4  UDB4 '...    ' NSB5  EWB5  UDB5 '...
    ' S1C1  S1C2  S1C3  S1C4  S1C5  S1C6  S1C7  S1C8  S1C9 S1C10 S1C11 '...S1C12 '...
    ' NSC1  NSC2  NSC3  NSC4  NSC5  NSC6  NSC7  NSC8  NSC9 NSC10 NSC11 '...NSC12 '...
    ' EWC1  EWC2  EWC3  EWC4  EWC5  EWC6  EWC7  EWC8  EWC9 EWC10 EWC11 '...EWC12 '...
    ' UDC1  UDC2  UDC3  UDC4  UDC5  UDC6  UDC7  UDC8  UDC9 UDC10 UDC11 '...UDC12 '...
    'NSCR1 EWCR1 UDCR1'...
    '\n']);

fprintf(rfp,[...
    ' STATION NAME  NUM       X-COOR       Y-COOR  EpDis(km) '...
    '  FS1   FS2   FB1   FB2   FB3 '...  FB4   FB5 '... 6 7 8 9 10 11 12
    ' NSS1  EWS1  UDS1 '... 13 14 15
    ' NSS2  EWS2  UDS2 '... 16 17 18
    ' NSB1  EWB1  UDB1 '... 19 20 21
    ' NSB2  EWB2  UDB2 '... 22 23 24
    ' NSB3  EWB3  UDB3 '... 25 26 27    ' NSB4  EWB4  UDB4 '... 28 29 30    ' NSB5  EWB5  UDB5 '... 31 32 33
    ' S1C1  S1C2  S1C3  S1C4  S1C5  S1C6  S1C7  S1C8  S1C9 '...S1C10 '... 34 35 36 37 38 39 40 41 42
    ' NSC1  NSC2  NSC3  NSC4  NSC5  NSC6  NSC7  NSC8  NSC9 '...NSC10 '...
    ' EWC1  EWC2  EWC3  EWC4  EWC5  EWC6  EWC7  EWC8  EWC9 '...EWC10 '...
    ' UDC1  UDC2  UDC3  UDC4  UDC5  UDC6  UDC7  UDC8  UDC9 '...UDC10 '...
    'NSCR1 EWCR1 UDCR1'...
    '\n']);

fprintf(mfp,[...
    ' STATION NAME  NUM       X-COOR       Y-COOR  EpDis(km) '...
    '    PGD-S     PGD-D     PGV-S     PGV-D     PGA-S     PGA-D '...
    ' PGD-NS-S  PGD-EW-S  PGD-UD-S  PGD-NS-D  PGD-EW-D  PGD-UD-D '...
    ' PGV-NS-S  PGV-EW-S  PGV-UD-S  PGV-NS-D  PGV-EW-D  PGV-UD-D '...
    ' PGA-NS-S  PGA-EW-S  PGA-UD-S  PGA-NS-D  PGA-EW-D  PGA-UD-D '...
    '  AI-NS-S   AI-EW-S   AI-UD-S   AI-NS-D   AI-EW-D   AI-UD-D '...
    '   E-NS-S    E-EW-S    E-UD-S    E-NS-D    E-EW-D    E-UD-D '...
    ' DUR-NS-S  DUR-EW-S  DUR-UD-S  DUR-NS-D  DUR-EW-D  DUR-UD-D '...
    '  T1-NS-S   T1-EW-S   T1-UD-S   T1-NS-D   T1-EW-D   T1-UD-D '...
    '  T2-NS-S   T2-EW-S   T2-UD-S   T2-NS-D   T2-EW-D   T2-UD-D '...
    '  PT-NS-S   PT-EW-S   PT-UD-S   PT-NS-D   PT-EW-D   PT-UD-D '...
    '     PT-S      PT-D   Earlate '...
    '\n']);

for j = 1:N
    
    clf(hf);
    
    display(['Processing station ' int2str(j) ' of ' int2str(N)]);
    stationName   = fscanf(sfp, '%s', 1);
    stationNumber = fscanf(sfp, '%d', 1);
    stationX      = fscanf(sfp, '%f', 1);
    stationY      = fscanf(sfp, '%f', 1);

    % Ensure observed data exists
    filename = sprintf('%s/%s.her', dataRoot, stationName);
    if (exist(filename, 'file') ~= 2)
        % Skip missing station
        continue;
    end
    
    [   S1, myS1, S2, myS2, ...
        B1, B2, B3, ...B4, B5, ...
        myB1, myB2, myB3, ...myB4, myB5, ...
        iS2, iB1, iB2, iB3, ...iB4, iB5, ...
        TIME, DT, AS, VS, DS, AD, VD, DD, ...
        FREQ, FVS, FVD, PERIOD, RSS, RSD, ... HVS, HVD, ...
        ptS, ptD, CR1] ...
        = compute_metrics(stationName,stationNumber,dataRoot,simuRoot);
    
    mdS1 = mean(S1,1);
    mcS1 = mean(S1,2);
    FS1  = mean(mdS1);
    
    mS2 = mean(mean(S2));
    mB1 = mean(mean(B1));
    mB2 = mean(mean(B2));
    mB3 = mean(mean(B3));
%    mB4 = mean(mean(B4));
%    mB5 = mean(mean(B5));

    dS2 = mean(S2);
    dB1 = mean(B1);
    dB2 = mean(B2);
    dB3 = mean(B3);
%    dB4 = mean(B4);
%    dB5 = mean(B5);

    mdMyS1 = mean(myS1,1);
    mcMyS1 = mean(myS1,2);
    FMyS1  = mean(mdMyS1);
    
    mMyS2 = mean(mean(myS2));
    mMyB1 = mean(mean(myB1));
    mMyB2 = mean(mean(myB2));
    mMyB3 = mean(mean(myB3));
%    mMyB4 = mean(mean(myB4));
%    mMyB5 = mean(mean(myB5));

    dMyS2 = mean(myS2);
    dMyB1 = mean(myB1);
    dMyB2 = mean(myB2);
    dMyB3 = mean(myB3);
%    dMyB4 = mean(myB4);
%    dMyB5 = mean(myB5);
    
    % PATRICK... come back and change epicentral coords
    % Chino Hills epicentral coords
    %epdis = sqrt((120031.63-stationX)^2+(74847.06-stationY)^2)/1000;
    % La Habra epicentral coords
    epdis = sqrt((110678.625325-stationX)^2+(62335.309996-stationY)^2)/1000;

    fprintf(cfp,[...
        '%13s %4d %12.4f %12.2f %10.2f '...
        '%5.2f %5.2f %5.2f %5.2f %5.2f '...%5.2f %5.2f '...
        '%5.2f %5.2f %5.2f '...
        '%5.2f %5.2f %5.2f '...
        '%5.2f %5.2f %5.2f '...
        '%5.2f %5.2f %5.2f '...
        '%5.2f %5.2f %5.2f '...        '%5.2f %5.2f %5.2f '...        '%5.2f %5.2f %5.2f '...
        '%5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f '...%5.2f '...
        '%5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f '...%5.2f '...
        '%5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f '...%5.2f '...
        '%5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f '...%5.2f '...
        '%5.2f %5.2f %5.2f'...
        '\n'], ...
        stationName, stationNumber, stationX, stationY, epdis, ...
        FS1, mS2, mB1, mB2, mB3, ...mB4, mB5,...
        mdS1,...
        dS2,...
        dB1,...
        dB2,...
        dB3,...        dB4,...        dB5,...
        mcS1,...
        S1,...
        CR1...
        );

    fprintf(rfp,[...
        '%13s %4d %12.4f %12.4f %10.2f '...
        '%5.2f %5.2f %5.2f %5.2f %5.2f '...%5.2f %5.2f '...
        '%5.2f %5.2f %5.2f '...
        '%5.2f %5.2f %5.2f '...
        '%5.2f %5.2f %5.2f '...
        '%5.2f %5.2f %5.2f '...
        '%5.2f %5.2f %5.2f '...        '%5.2f %5.2f %5.2f '...        '%5.2f %5.2f %5.2f '...
        '%5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f '...%5.2f '...
        '%5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f '...%5.2f '...
        '%5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f '...%5.2f '...
        '%5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f %5.2f '...%5.2f '...
        '%5.2f %5.2f %5.2f'...
        '\n'], ...
        stationName, stationNumber, stationX, stationY, epdis, ...
        FMyS1, mMyS2, mMyB1, mMyB2, mMyB3, ...mMyB4, mMyB5,...
        mdMyS1,...
        dMyS2,...
        dMyB1,...
        dMyB2,...
        dMyB3,...        dMyB4,...        dMyB5,...
        mcMyS1,...
        myS1,...
        CR1...
        );

    fprintf(mfp,[...
        '%13s %4d %12.4f %12.4f %10.2f '...
        '%9.2f %9.2f %9.2f %9.2f %9.2f %9.2f '...
        '%9.2f %9.2f %9.2f %9.2f %9.2f %9.2f '...
        '%9.2f %9.2f %9.2f %9.2f %9.2f %9.2f '...
        '%9.2f %9.2f %9.2f %9.2f %9.2f %9.2f '...
        '%9.2f %9.2f %9.2f %9.2f %9.2f %9.2f '...
        '%9.2f %9.2f %9.2f %9.2f %9.2f %9.2f '...
        '%9.2f %9.2f %9.2f %9.2f %9.2f %9.2f '...
        '%9.2f %9.2f %9.2f %9.2f %9.2f %9.2f '...
        '%9.2f %9.2f %9.2f %9.2f %9.2f %9.2f '...
        '%9.2f %9.2f %9.2f '...
        '%9.2f %9.2f %9.2f '...
        '%9.2f %9.2f %9.2f '...
        '\n'],...
        stationName, stationNumber, stationX, stationY, epdis, ...
        max(iS2(4,1:3)),max(iS2(4,4:6)),...
        max(iS2(5,1:3)),max(iS2(5,4:6)),...
        max(iS2(6,1:3)),max(iS2(6,4:6)),...
        iS2(4,:), ...
        iS2(5,:), ...
        iS2(6,:), ...
        iS2(10,:), ...
        iS2(11,:), ...
        iS2(12,:), ...
        iS2(13,:), ...
        iS2(14,:), ...
        ptS, ...
        ptD, ...
        mean(ptS), mean(ptD), mean(ptS)-mean(ptD) ...
        );
    
    figure(hf);
    for i = 1:3
        
        % Velocity Traces
        subplot(3,24,[(i-1)*24+1 (i-1)*24+7]);
        
        plot(TIME,VD(:,i),'r');
        hold on;
        plot(TIME,VS(:,i),'b');
        
        plot(iS2(2,i+3), iS2(8,i+3),'or','MarkerSize',5);
        plot(iS2(2, i ), iS2(8,i),'ob','MarkerSize',5);

        themax = max(iS2(5,i),iS2(5,i+3))*1.2;
        plot([ptD(i) ptD(i)], [-themax themax],'--r');
        plot([ptS(i) ptS(i)], [-themax themax],'--b');

        plot([iS2(13,i+3) iS2(14,i+3)],[themax*.83 themax*0.83],'+-r');
        plot([iS2(13,i) iS2(14,i)],[themax*.9 themax*0.9],'+-b');
        
        hold off;
        if (i == 1)
            title(['Station ' stationName ' (' int2str(stationNumber) ') --- Velocity (cm/s)']);
        end
        ylabel(ylabels(i,:));
        if (i == 3)
            xlabel('Time (s)');
        end
        xlim([0 TIME(length(TIME))]);
        ylim([-themax themax]);

        % Fourier Spectra
        subplot(3,24,[(i-1)*24+9 (i-1)*24+12]);
        
        plot(FREQ,FVD(:,i),'r');
        hold on;
        plot(FREQ,FVS(:,i),'b');
        hold off;
        if (i == 1)
            title(['Fourier Spectra (cm)']);
        end
        if (i == 3)
            xlabel('Frquency (Hz)');
        end
        xlim([0 1]);

        % Response Spectra
        subplot(3,24,[(i-1)*24+14 (i-1)*24+17]);
        semilogx(PERIOD,RSD(:,i),'r');
        hold on;
        semilogx(PERIOD,RSS(:,i),'b');
        hold off;
        if (i == 1)
            title(['Response Spectra (cm)']);
        end
        if (i == 3)
            xlabel('Period (s)');
        end
        xlim([0.1 10]);

    end
    
    subplot(3,24,[19 2*24]);


    text(0.20, 1.00, 'NS','FontSize',8);
    text(0.33, 1.00, 'EW','FontSize',8);
    text(0.48, 1.00, 'UD','FontSize',8);

    text(   0, 0.95, 'S1 = ','FontSize',8);
    text(0.17, 0.95, num2str(mdS1,'%8.2f'),'FontSize',8,'FontWeight','bold');
    text(0.68, 0.95, num2str(FS1,'%8.2f'),'FontSize',8,'Color','r','FontWeight','bold');
    text(0.90, 0.95, 'JA','FontSize',8);

%     text(   0, 0.80, ['S2 = ';'B1 = ';'B2 = ';'B3 = ';'B4 = ';'B5 = '],'FontSize',8);
%     text(0.17, 0.80, [num2str([dS2;dB1;dB2;dB3;dB4;dB5],'%8.2f')],'FontSize',8);
%     text(0.68, 0.80, [num2str([mS2;mB1;mB2;mB3;mB4;mB5],'%8.2f')],'FontSize',8,'FontWeight','bold');

    text(   0, 0.80, ['S2 = ';'B1 = ';'B2 = ';'B3 = '],'FontSize',8);
    text(0.17, 0.80, [num2str([dS2;dB1;dB2;dB3],'%8.2f')],'FontSize',8);
    text(0.68, 0.80, [num2str([mS2;mB1;mB2;mB3],'%8.2f')],'FontSize',8,'FontWeight','bold');
    
    text(   0, 0.62, 'S1 = ','FontSize',8);
    text(0.17, 0.62, num2str(mdMyS1,'%8.2f'),'FontSize',8,'FontWeight','bold');
    text(0.68, 0.62, num2str(FMyS1,'%8.2f'),'FontSize',8,'Color','r','FontWeight','bold');
    text(0.90, 0.62, 'RT','FontSize',8);

%     text(   0, 0.47, ['S2 = ';'B1 = ';'B2 = ';'B3 = ';'B4 = ';'B5 = '],'FontSize',8);
%     text(0.17, 0.47, [num2str([dMyS2;dMyB1;dMyB2;dMyB3;dMyB4;dMyB5],'%8.2f')],'FontSize',8);
%     text(0.68, 0.47, [num2str([mMyS2;mMyB1;mMyB2;mMyB3;mMyB4;mMyB5],'%8.2f')],'FontSize',8,'FontWeight','bold');
    
    text(   0, 0.47, ['S2 = ';'B1 = ';'B2 = ';'B3 = '],'FontSize',8);
    text(0.17, 0.47, [num2str([dMyS2;dMyB1;dMyB2;dMyB3],'%8.2f')],'FontSize',8);
    text(0.68, 0.47, [num2str([mMyS2;mMyB1;mMyB2;mMyB3],'%8.2f')],'FontSize',8,'FontWeight','bold');
    
    text(   0, 0.10, ['C1  = ';'C2  = ';'C3  = ';'C4  = ';'C5  = ';...
        'C6  = ';'C7  = ';'C8  = ';'C9  = ';'C10 = ';'C11 = '],'FontSize',8);%;'C12 = ']);
    text(0.17, 0.10, [num2str(S1,'%8.2f')],'FontSize',8);
    text(0.68, 0.10, [num2str(mcS1,'%8.2f')],'FontSize',8,'FontWeight','bold');

    axis off;

    % Map
    subplot(3,24,[67 72]);
    
    load shore_line_xy.mat
    plot(x,y,'k');
    axis equal
    xlim([0 180000]);
    ylim([0 135000]);
    set(gca,'XTick',[]);
    set(gca,'YTick',[]);
    hold on;
    plot(120031.63,74847.06,...
        'p','LineWidth',1,'MarkerEdgeColor','k',...
        'MarkerFaceColor','y','MarkerSize',8);    
    plot(stationX,stationY,...
        'o','LineWidth',1,'MarkerEdgeColor','k',...
        'MarkerFaceColor','r','MarkerSize',5);    
    
    if j == 1
        print(hf, '-dpsc', outputfile);
    else
        print(hf, '-dpsc', outputfile, '-append');
    end
    
end

fclose(sfp);
fclose(cfp);
fclose(rfp);
fclose(mfp);

